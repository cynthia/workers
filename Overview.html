<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- when publishing, change bits marked ZZZ -->

<html lang=en-US-x-Hixie>
 <head>
  <title>Web Workers</title>
  <link href="http://www.w3.org/StyleSheets/TR/%57%33%43-ED" rel=stylesheet
  type="text/css">
  <!-- ZZZ ED vs WD -->

 <body>
  <div class=head>
   <p><a href="http://www.w3.org/"><img alt=W3C height=48
    src="http://www.w3.org/Icons/w3c_home" width=72></a></p>

   <h1 id=web-workers>Web Workers</h1>

   <h2 class="no-num no-toc" id=an-accompaniment>An accompaniment
    specification for HTML5</h2>

   <h2 class="no-num no-toc" id=editors><!-- "W3C Working Draft" --> Editor's
    Draft <!--ZZZ-->18 July 2008</h2>

   <dl><!-- ZZZ: update the month/day
    <dt>This Version:</dt>
    <dd><a href="http://www.w3.org/TR/2008/WD-workers-20080101/">http://www.w3.org/TR/2008/WD-workers-20080101/</a></dd>
    <dt>Latest Published Version:</dt>
    <dd><a href="http://www.w3.org/TR/workers/">http://www.w3.org/TR/workers/</a></dd>
 :ZZZ -->

    <dt>Latest Editor's Draft:

    <dd><a
     href="http://dev.w3.org/html5/workers/">http://dev.w3.org/html5/workers/</a></dd>
    <!-- ZZZ: add the new version after it has shipped
    <dt>Previous Versions:</dt>
    <dd><a href="http://www.w3.org/TR/2008/WD-workers-20080101/">http://www.w3.org/TR/2008/WD-workers-20080101/</a>
 :ZZZ -->

    <dt>Editors:

    <dd><a href="mailto:ian@hixie.ch">Ian Hickson</a>, Google, Inc.
   </dl>

   <p class=copyright><a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>
    &#169; 2008 <a href="http://www.w3.org/"><abbr title="World Wide Web
    Consortium">W3C</abbr></a><sup>&#174;</sup> (<a
    href="http://www.csail.mit.edu/"><abbr title="Massachusetts Institute of
    Technology">MIT</abbr></a>, <a href="http://www.ercim.org/"><abbr
    title="European Research Consortium for Informatics and
    Mathematics">ERCIM</abbr></a>, <a
    href="http://www.keio.ac.jp/">Keio</a>), All Rights Reserved. W3C <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#Legal_Disclaimer">liability</a>,
    <a
    href="http://www.w3.org/Consortium/Legal/ipr-notice#W3C_Trademarks">trademark</a>
    and <a
    href="http://www.w3.org/Consortium/Legal/copyright-documents">document
    use</a> rules apply.</p>
   <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
   
   <p class="alt copyright">The <a
    href="http://www.whatwg.org/specs/web-workers/current-work/">WHATWG
    version</a> of this specification is available under a more permissive
    license.</p>
   <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
   </div>

  <hr>

  <h2 class="no-num no-toc" id=abstract>Abstract</h2>

  <p>This specification defines an API that allows Web application authors to
   spawn background workers running scripts in parallel to their main page.
   This allows for thread-like operation with message-passing as the
   coordination mechanism.

  <h2 class="no-num no-toc" id=status>Status of this document</h2>
  <!-- intro boilerplate (required) -->

  <p><em>This section describes the status of this document at the time of
   its publication. Other documents may supersede this document. A list of
   current W3C publications and the most recently formally published revision
   of this technical report can be found in the <a
   href="http://www.w3.org/TR/">W3C technical reports index</a> at
   http://www.w3.org/TR/.</em></p>
  <!-- where to send feedback (required) -->

  <p>If you wish to make comments regarding this document, please send them
   to <a
   href="mailto:public-html-comments@w3.org">public-html-comments@w3.org</a>
   (<a
   href="mailto:public-html-comments-request@w3.org?subject=subscribe">subscribe</a>,
   <a
   href="http://lists.w3.org/Archives/Public/public-html-comments/">archives</a>)
   <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING SENTENCE TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
   or <a href="mailto:whatwg@whatwg.org">whatwg@whatwg.org</a> (<a
   href="http://lists.whatwg.org/listinfo.cgi/whatwg-whatwg.org">subscribe</a>,
   <a
   href="http://lists.whatwg.org/pipermail/whatwg-whatwg.org/">archives</a>).
   <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING SENTENCE TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
   All feedback is welcome.</p>
  <!-- stability (required) -->

  <p>Implementors should be aware that this specification is not stable.
   <strong>Implementors who are not taking part in the discussions are likely
   to find the specification changing out from under them in incompatible
   ways.</strong> Vendors interested in implementing this specification
   before it eventually reaches the Candidate Recommendation stage should
   join the aforementioned mailing lists and take part in the discussions.</p>
  <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- version history or list of changes (required) -->

  <p>The latest stable version of the editor's draft of this specification is
   always available on <a
   href="http://dev.w3.org/html5/workers/Overview.html">the W3C CVS
   server</a> and in the <a href="http://svn.whatwg.org/webworkers/">WHATWG
   Subversion repository</a>. The latest editor's working copy (which may
   contain unfinished text in the process of being prepared) is available <a
   href="http://www.whatwg.org/specs/web-workers/current-work/">on the WHATWG
   site</a>. Detailed change history can be obtained from the following
   locations:</p>
  <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING LIST TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->

  <ul>
   <li>Twitter messages (non-editorial changes only): <a
    href="http://twitter.com/WHATWG">http://twitter.com/WHATWG</a>

   <li>Interactive Web interface: <a
    href="http://html5.org/tools/web-workers-tracker">http://html5.org/tools/web-workers-tracker</a>

   <li>Commit-Watchers mailing list: <a
    href="http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org">http://lists.whatwg.org/listinfo.cgi/commit-watchers-whatwg.org</a>

   <li>Subversion interface: <a
    href="http://svn.whatwg.org/webworkers/">http://svn.whatwg.org/webworkers/</a>

   <li>CVS log: <a
    href="http://dev.w3.org/cvsweb/html5/workers/Overview.html">http://dev.w3.org/cvsweb/html5/workers/Overview.html</a>
  </ul>
  <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING LIST TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- status of document, group responsible (required) -->

  <p>The W3C <a href="http://www.w3.org/html/wg/">HTML Working Group</a> is
   the W3C working group responsible for this specification's progress along
   the W3C Recommendation track. <!--ZZZ:--> This specification is the 18
   July 2008 <!--ZZZ "Working Draft"-->Editor's Draft. <!--:ZZZ--></p>
  <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- relationship to other work (required) -->

  <p>This specification is also being produced by the <a
   href="http://www.whatwg.org/">WHATWG</a>. The two specifications are
   identical from the table of contents onwards.</p>
  <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- UNDER NO CIRCUMSTANCES IS THE PRECEDING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- context and rationale (required) -->

  <p>This specification is intended to specify a part of the Web platform
   closely related to HTML5. It is defined in a separate document primarily
   to ease the cognitive load on reviewers.</p>
  <!-- UNDER NO CIRCUMSTANCES IS THE FOLLOWING PARAGRAPH TO BE REMOVED OR EDITED WITHOUT TALKING TO IAN FIRST -->
  <!-- required patent boilerplate -->

  <p>This document was produced by a group operating under the <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February
   2004 W3C Patent Policy</a>. W3C maintains a <a
   href="http://www.w3.org/2004/01/pp-impl/40318/status"
   rel=disclosure>public list of any patent disclosures</a> made in
   connection with the deliverables of the group; that page also includes
   instructions for disclosing a patent. An individual who has actual
   knowledge of a patent which the individual believes contains <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
   Claim(s)</a> must disclose the information in accordance with <a
   href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
   6 of the W3C Patent Policy</a>.

  <h2 class="no-num no-toc" id=contents>Table of contents</h2>
  <!--begin-toc-->

  <ul class=toc>
   <li><a href="#introduction"><span class=secno>1. </span>Introduction</a>
    <ul class=toc>
     <li><a href="#tutorial"><span class=secno>1.1 </span>Tutorial</a>

     <li><a href="#requirements"><span class=secno>1.2
      </span>Requirements</a>

     <li><a href="#conformance"><span class=secno>1.3 </span>Conformance
      requirements</a>
      <ul class=toc>
       <li><a href="#dependencies"><span class=secno>1.3.1
        </span>Dependencies</a>
      </ul>

     <li><a href="#terminology"><span class=secno>1.4 </span>Terminology</a>
    </ul>

   <li><a href="#inside"><span class=secno>2. </span>Inside workers</a>
    <ul class=toc>
     <li><a href="#the-windowworker"><span class=secno>2.1 </span>The
      <code>WindowWorker</code> interface</a>

     <li><a href="#the-queue"><span class=secno>2.2 </span>The queue of
      events</a>

     <li><a href="#the-workers"><span class=secno>2.3 </span>The worker's
      ports</a>

     <li><a href="#processing"><span class=secno>2.4 </span>Processing
      model</a>
    </ul>

   <li><a href="#creating"><span class=secno>3. </span>Creating workers</a>
    <ul class=toc>
     <li><a href="#the-windowworkercreators"><span class=secno>3.1 </span>The
      <code>WindowWorkerCreators</code> interface</a>
    </ul>

   <li class=no-num><a href="#references">References</a>

   <li class=no-num><a href="#acknowledgements">Acknowledgements</a>
  </ul>
  <!--end-toc-->

  <hr>

  <h2 id=introduction><span class=secno>1. </span>Introduction</h2>

  <h3 id=tutorial><span class=secno>1.1 </span>Tutorial</h3>

  <p><em>This section is non-normative.</em>

  <p class=big-issue>This section is missing.

  <h3 id=requirements><span class=secno>1.2 </span>Requirements</h3>

  <p><em>This section is non-normative.</em>

  <p>This specification aims to address the following use cases and
   requirements:

  <ul>
   <li>Background workers: A Web application needs to keep its data
    synchronised with the server, both sending updates to the server and
    receiving updates from the server, including handling buffering of
    updates for when the application goes offline. The code to do this would
    ideally be independent of the UI code.

   <li>URLs: Workers should be spawned from URLs, not from strings, since
    script rarely has access to its own source.

   <li>Message queuing: Messages sent to a worker before the worker has
    initialised should not be lost.

   <li>Workers should have access to timers.

   <li>Workers should have access to the network.

   <li>Workers should be able to use libraries.

   <li>Implementations should not have to expose <code>Node</code> or
    <code>Document</code> objects to workers.

   <li>Workers should not share anything with the outside world. The objects
    representing the worker in the worker itself and in the context that
    created the worker should be different, for instance.

   <li>Shared workers: Multiple instances of the same Web application would
    want to keep just one connection back to the server.

   <li>Capabilities granting: It should be possible for code running in one
    iframe to negotiate a connection to another iframe, with that connection
    granting certain rights (e.g. adding to an address book but not reading
    from it).

   <li>Delegation: It should be possible for one worker to spawn another
    worker and efficiently delagate a request to that worker, without the
    caller being aware of the delagate and without the original worker having
    to proxy all the messages.

   <li>Workers whose parents are not longer useful should be killed. Workers
    should be able to detect this is about to happen and exit gracefully.
  </ul>

  <h3 id=conformance><span class=secno>1.3 </span>Conformance requirements</h3>

  <p>All diagrams, examples, and notes in this specification are
   non-normative, as are all sections explicitly marked non-normative.
   Everything else in this specification is normative.

  <p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
  NOT",-->
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in the
   normative parts of this document are to be interpreted as described in
   RFC2119. For readability, these words do not appear in all uppercase
   letters in this specification. <a href="#refsRFC2119">[RFC2119]</a></p>
  <!-- XXX but they should be
  marked up -->

  <p>Requirements phrased in the imperative as part of algorithms (such as
   "strip any leading space characters" or "return false and abort these
   steps") are to be interpreted with the meaning of the key word ("must",
   "should", "may", etc) used in introducing the algorithm.

  <p>Some conformance requirements are phrased as requirements on attributes,
   methods or objects. Such requirements are to be interpreted as
   requirements on user agents.

  <p>Conformance requirements phrased as algorithms or specific steps may be
   implemented in any manner, so long as the end result is equivalent. (In
   particular, the algorithms defined in this specification are intended to
   be easy to follow, and not intended to be performant.)

  <p>The only conformance class defined by this specification is user agents.

  <p>User agents may impose implementation-specific limits on otherwise
   unconstrained inputs, e.g. to prevent denial of service attacks, to guard
   against running out of memory, or to work around platform-specific
   limitations.

  <h4 id=dependencies><span class=secno>1.3.1 </span>Dependencies</h4>

  <p>This specification relies on several other underlying specifications.

  <dl>
   <dt>HTML5

   <dd>
    <p>Many fundamental concepts from HTML5 are used by this specification.
     <a href="#refsHTML5">[HTML5]</a></p>

   <dt>ECMAScript

   <dd>
    <p>This specification is intended to be used with JavaScript as the
     scripting language. <a href="#refsJS">[JS]</a></p>

   <dt>WebIDL

   <dd>
    <p>The IDL blocks in this specification use the semantics of the WebIDL
     specification. <a href="#refsWebIDL">[WebIDL]</a></p>
  </dl>

  <h3 id=terminology><span class=secno>1.4 </span>Terminology</h3>

  <p>For simplicity, terms such as <em>shown</em>, <em>displayed</em>, and
   <em>visible</em> might sometimes be used when referring to the way a
   document is rendered to the user. These terms are not meant to imply a
   visual medium; they must be considered to apply to other media in
   equivalent ways.

  <p>The construction "a <code title="">Foo</code> object", where <code
   title="">Foo</code> is actually an interface, is sometimes used instead of
   the more accurate "an object implementing the interface <code
   title="">Foo</code>".

  <p>The term DOM is used to refer to the API set made available to scripts
   in Web applications, and does not necessarily imply the existence of an
   actual <code>Document</code> object or of any other <code>Node</code>
   objects as defined in the DOM Core specifications. <a
   href="#refsDOM3CORE">[DOM3CORE]</a>

  <p>A DOM attribute is said to be <em>getting</em> when its value is being
   retrieved (e.g. by author script), and is said to be <em>setting</em> when
   a new value is assigned to it.

  <p>If a DOM object is said to be <dfn id=live>live</dfn>, then that means
   that any attributes returning that object must always return the same
   object (not a new object each time), and the attributes and methods on
   that object must operate on the actual underlying data, not a snapshot of
   the data.

  <h2 id=inside><span class=secno>2. </span>Inside workers</h2>

  <h3 id=the-windowworker><span class=secno>2.1 </span>The <code><a
   href="#windowworker">WindowWorker</a></code> interface</h3>

  <pre
   class=idl>[NoInterfaceObject] interface <dfn id=windowworker>WindowWorker</dfn> {
  readonly attribute DOMString <a href="#url" title=dom-windowworker-URL>URL</a>;
  readonly attribute DOMString <a href="#name" title=dom-windowworker-name>name</a>;
  readonly attribute boolean <a href="#closing" title=dom-windowworker-closing>closing</a>;
  void <a href="#close" title=dom-windowworker-close>close</a>();

  // event handler attributes
           attribute <span>EventListener</span> <a href="#onattach" title=handler-windowworker-onattach>onattach</a>;
           attribute <span>EventListener</span> <a href="#onunload" title=handler-windowworker-onunload>onunload</a>;
};</pre>

  <p>Objects that implement the <code><a
   href="#windowworker">WindowWorker</a></code> interface must also implement
   the <code>Window</code> interface (and thus also the
   <code>WindowTimers</code> and <code><a
   href="#windowworkercreators">WindowWorkerCreators</a></code> interfaces)
   and the <code>EventTarget</code> interface.

  <p>The <dfn id=url title=dom-windowworker-URL><code>URL</code></dfn>
   attribute must return the value it was assigned when the <code><a
   href="#windowworker">WindowWorker</a></code> object was created by the "<a
   href="#run-a">run a worker</a>" algorithm. It gives the <span>absolute
   URL</span> of the script that was used to initialize the worker.

  <p>The <dfn id=name title=dom-windowworker-name><code>name</code></dfn>
   attribute must return the value it was assigned when the <code><a
   href="#windowworker">WindowWorker</a></code> object was created by the "<a
   href="#run-a">run a worker</a>" algorithm. If it has a value that isn't
   the empty string, its value represents the name that can be used to obtain
   a reference to the worker using the <code
   title=dom-WindowWorkerCreators-createNamedWorker>createNamedWorker()</code>
   method.

  <p>The <dfn id=closing
   title=dom-windowworker-closing><code>closing</code></dfn> attribute must
   return false until the "<a href="#kill-a">kill a worker</a>" processing
   model defined below sets it to false.

  <p>The following are the <span>event handler DOM attributes</span> that
   must be supported by objects implementing the <code><a
   href="#windowworker">WindowWorker</a></code> interface:

  <dl>
   <dt><dfn id=onattach
    title=handler-windowworker-onattach><code>onattach</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code
     title=event-windowworker-attach>attach</code> event is targeted at or
     bubbles through the <code><a
     href="#windowworker">WindowWorker</a></code> object.

   <dt><dfn id=onunload
    title=handler-windowworker-onunload><code>onunload</code></dfn>

   <dd>
    <p>Must be invoked whenever a <code title=event-unload>unload</code>
     event is targeted at or bubbles through the <code><a
     href="#windowworker">WindowWorker</a></code> object.
  </dl>

  <h3 id=the-queue><span class=secno>2.2 </span>The queue of events</h3>

  <p>Each <code><a href="#windowworker">WindowWorker</a></code> object is
   asssociated with a <dfn id=queue>queue of events</dfn>, which is initially
   empty.

  <p>An event in the queue can be a DOM event or a timeout callback.

  <p>All asynchronous callbacks and events that would be called or dispatched
   in the worker must be added to the worker's queue, with the "<a
   href="#run-a">run a worker</a>" processing model below taking care of
   actually calling the callbacks or dispatching the events.

  <p>Once the <code><a href="#windowworker">WindowWorker</a></code>'s <code
   title=dom-windowworker-closing><a href="#closing">closing</a></code>
   attribute is set to true, the queue must discard anything else that would
   be added to it. Effectively, once the <code
   title=dom-windowworker-closing><a href="#closing">closing</a></code>
   attribute is true, timers stop firing, notifications for all pending
   asynchronous operations are dropped, etc.

  <h3 id=the-workers><span class=secno>2.3 </span>The worker's ports</h3>

  <p>Workers communicate with other workers and with <span title="browsing
   context">browsing contexts</span> through <span title="channel
   messaging">message channels</span> and their <code>MessagePort</code>
   objects.

  <p>Each <code><a href="#windowworker">WindowWorker</a></code> <var
   title="">worker</var> has a list of <dfn id=the-workers0>the worker's
   ports</dfn>, which consists of all the <code>MessagePort</code> objects
   that are entangled with another port and that have one (but only one) port
   whose <code title=dom-MessagePort-ownerWindow>ownerWindow</code> is <var
   title="">worker</var>. This list includes all the <code>MessagePort</code>
   objects that are in events pending in the <a href="#queue">queue of
   events</a>.

  <h3 id=processing><span class=secno>2.4 </span>Processing model</h3>

  <p>When a user agent is to <dfn id=run-a>run a worker</dfn> named <var
   title="">name</var> for a script with <span>URL</span> <var
   title="">url</var>, a browsing context <var title="">owner browsing
   context</var> and a <code>Document</code> <var title="">owner
   document</var>, it must run the following steps in a completely separate
   and parallel execution environment:

  <ol>
   <li>
    <p>Attempt to <span>fetch</span><!-- XXX --> the resource identified by
     <var title="">url</var>.</p>

    <p>If the attempt fails, then abort these steps and invoke the <a
     href="#worker" title="worker creation failed">error handling steps</a>
     defined by the algorithm that called this one.</p>

    <p>If the attempt succeeds, then let <var title="">script</var> be the
     resource that was obtained.</p>

    <p class=note>As with <code>script</code> elements, the MIME type of the
     script is ignored. Unlike with <code>script</code> elements, there is no
     way to override the type. It's always assumed to be JavaScript.</p>
    <!-- XXX people will complain about
    this. I guess we might want to examine the MIME type... -->
    

   <li>
    <p>Create a new <code><a href="#windowworker">WindowWorker</a></code>
     object, <var title="">window</var>.</p>

   <li>
    <p>Set the <code title=dom-windowworker-URL><a href="#url">URL</a></code>
     attribute of <var title="">window</var> to the value of <var
     title="">url</var>.</p>

   <li>
    <p>Set the <code title=dom-windowworker-name><a
     href="#name">name</a></code> attribute of <var title="">window</var> to
     the value of <var title="">name</var>.</p>

   <li>
    <p>Let <var title="">script</var>'s <span>script execution context</span>
     (and thus also <span>global object</span>) be <var
     title="">window</var>.</p>

   <li>
    <p>Let <var title="">script</var>'s <span>script browsing context</span>
     be <var title="">owner browsing context</var>.</p>

   <li>
    <p>Let <var title="">script</var>'s <span>script document context</span>
     be <var title="">owner document</var>.</p>

   <li>
    <p>Invoke the <a href="#success" title="worker creation
     succeeded">success steps</a> defined by the algorithm that called this
     one. (This will add an event to the <a href="#queue">queue of
     events</a>.)</p>

   <li>
    <p>Start monitoring <var title="">worker</var>, such that whenever the
     <var title="">window</var> object's <code
     title=dom-windowworker-closing><a href="#closing">closing</a></code>
     attribute is false and all <a href="#the-workers0">the worker's
     ports</a> have their <code title=dom-MessagePort-active>active</code>
     attributes set to false, the user agent suspends execution of script in
     that worker until such time as either the <code
     title=dom-windowworker-closing><a href="#closing">closing</a></code>
     attribute switches to true or one of the <code>MessagePort</code>
     objects in the list of <a href="#the-workers0">the worker's ports</a>
     has an <code title=dom-MessagePort-active>active</code> attribute with
     the value true.</p>

   <li>
    <p>Start monitoring <var title="">worker</var>, such that as soon as the
     list of <a href="#the-workers0">the worker's ports</a> becomes empty,
     the <var title="">window</var> object's <code
     title=dom-windowworker-closing><a href="#closing">closing</a></code>
     attribute is set to true.</p>

   <li>
    <p>Run <var title="">script</var> until it either returns, fails to catch
     an exception, or gets prematurely aborted by the "<a href="#kill-a">kill
     a worker</a>" algorithm below.</p>

    <p class=note>If the script gets aborted by the "<a href="#kill-a">kill a
     worker</a>" algorithm, then that same algorithm will cause there to only
     be a single event in the <a href="#queue">queue of events</a> at the
     next step, namely the <code title=message-unload>unload</code> event.
     However, if the event is ignored then it will become true as soon as
     that port is garbage collected.</p>

   <li>
    <p><i>Event loop</i>: Wait until either there is an event in the <a
     href="#queue">queue of events</a> associated with <var
     title="">window</var> or the <var title="">window</var> object's <code
     title=dom-windowworker-closing><a href="#closing">closing</a></code>
     attribute is set to true.</p>

   <li>
    <p>Dispatch the oldest event or callback in the <a href="#queue">queue of
     events</a>, if any. The handling of this event or the execution of this
     callback might get prematurely aborted by the "<a href="#kill-a">kill a
     worker</a>" algorithm below.</p>

   <li>
    <p>If there are any more events in the <a href="#queue">queue of
     events</a> or if the <var title="">window</var> object's <code
     title=dom-windowworker-closing><a href="#closing">closing</a></code>
     attribute is set to false, then jump back to the step above labeled
     <i>event loop</i>.</p>

   <li>
    <p class=big-issue>timers, intervals, XMLHttpRequests, database
     transactions, etc, must be killed; ports must be deactivated and
     unentangled (do not send unload)</p>
  </ol>

  <hr>

  <p>When a user agent is to <dfn id=kill-a>kill a worker</dfn>, it must run
   the following steps in parallel with the worker's main loop (the "<a
   href="#run-a">run a worker</a>" processing model defined above):

  <ol>
   <li>
    <p>Create an <code>Event</code> object with the event name <code
     title=event-unload>unload</code>, which does not bubble and is not
     cancelable, and add it to the worker's <code><a
     href="#windowworker">WindowWorker</a></code> object's <a
     href="#queue">queue of events</a>, targetted at the <code><a
     href="#windowworker">WindowWorker</a></code> object itself.

   <li>
    <p>Set the worker's <code><a href="#windowworker">WindowWorker</a></code>
     object's <code title=dom-windowworker-closing><a
     href="#closing">closing</a></code> attribute to true.

   <li>
    <p>Wait a user-agent-defined amount of time. If the "<a href="#run-a">run
     a worker</a>" processing model defined above immediately starts running
     event listeners registered for <code title=event-unload>unload</code>
     event, this time should not be zero &mdash; the idea is that the <code
     title=event-unload>unload</code> event can be used to clean up when
     shutting down unexpectedly.

   <li>
    <p>If there are any events in the <a href="#queue">queue of events</a>
     other than the <code title=event-unload>unload</code> event that this
     algorithm just added, discard them without dispatching them.

   <li>
    <p>If the <code title=event-unload>unload</code> event that this
     algorithm just added hasn't yet been dispatched, then abort the script
     currently running in the worker.

   <li>
    <p>Wait a user-agent-defined amount of time.

   <li>
    <p>Abort the script currently running in the worker (if any script is
     running, then it will be a handler for the <code
     title=event-unload>unload</code> event).
  </ol>

  <hr>

  <p>When a script invokes the <dfn id=close
   title=dom-windowworker-close><code>close()</code></dfn> method on a
   <code><a href="#windowworker">WindowWorker</a></code> object, the user
   agent must run the following steps:

  <ol>
   <li>
    <p>Create an <code>Event</code> object with the event name <code
     title=event-unload>unload</code>, which does not bubble and is not
     cancelable, and add it to the <code><a
     href="#windowworker">WindowWorker</a></code> object's <a
     href="#queue">queue of events</a>, targetted at the <code><a
     href="#windowworker">WindowWorker</a></code> object itself.

   <li>
    <p>Set the worker's <code><a href="#windowworker">WindowWorker</a></code>
     object's <code title=dom-windowworker-closing><a
     href="#closing">closing</a></code> attribute to true.

   <li>
    <p>For each <code>MessagePort</code> object that is entangled with
     another port and that has one (but only one) port whose <code
     title=dom-MessagePort-ownerWindow>ownerWindow</code> is the <code><a
     href="#windowworker">WindowWorker</a></code> object on which the method
     was invoked, run the following substeps:</p>

    <ol>
     <li>
      <p>Unentangle the two ports.

     <li>
      <p>Set both ports' <code title=dom-MessagePort-active>active</code>
       attribute to false.

     <li>
      <p>At the next available opportunity, after any scripts have finished
       executing<!-- XXX queue -->, <span>fire a simple event</span> called
       <code title=event-unload>unload</code> at the other port (the one
       whose <code title=dom-MessagePort-ownerWindow>ownerWindow</code> is
       not the <code><a href="#windowworker">WindowWorker</a></code> object
       on which the <code title=dom-windowworker-close><a
       href="#close">close()</a></code> method was called).
    </ol>
  </ol>

  <h2 id=creating><span class=secno>3. </span>Creating workers</h2>

  <h3 id=the-windowworkercreators><span class=secno>3.1 </span>The <code><a
   href="#windowworkercreators">WindowWorkerCreators</a></code> interface</h3>

  <pre
   class=idl>[NoInterfaceObject] interface <dfn id=windowworkercreators>WindowWorkerCreators</dfn> {
  <span>MessagePort</span> <span title=dom-WindowWorkerCreators-createWorker>createWorker</span>(in DOMString scriptURL);
  <span>MessagePort</span> <span title=dom-WindowWorkerCreators-createNamedWorker>createNamedWorker</span>(in DOMString name, in DOMString scriptURL);
};</pre>

  <p>Objects that implement the <code>Window</code> interface must also
   implement the <code><a
   href="#windowworkercreators">WindowWorkerCreators</a></code> interface.

  <hr>

  <p>When the <code
   title=dom-WindowWorkerCreators-createWorker>createWorker(<var
   title="">scriptURL</var>)</code> method is invoked, the user agent must
   run the following steps:

  <ol>
   <li>
    <p><span title="resolve a url">Resolve</span> the <var
     title="">scriptURL</var> argument.

   <li>
    <p>If this fails, throw a <code>SYNTAX_ERR</code> exception.

   <li>
    <p>If the <span>origin</span> of the resulting <span>absolute URL</span>
     is not the <span title="same origin">same</span> as the origin of the
     script that invoked the method, then throw a <span>security
     exception</span>.

   <li>
    <p><a href="#create">Create a worker</a> from the resulting
     <span>absolute URL</span> whose name is the empty string.

   <li>
    <p>Return the <code>MessagePort</code> object returned from the <a
     href="#create">create a worker</a> algorithm.
  </ol>

  <hr>

  <p>When the <code
   title=dom-WindowWorkerCreators-createNamedWorker>createNamedWorker(<var
   title="">name</var>, <var title="">scriptURL</var>)</code> method is
   invoked, the user agent must run the following steps:

  <ol>
   <li>
    <p><span title="resolve a url">Resolve</span> the <var
     title="">scriptURL</var> argument.

   <li>
    <p>If this fails, throw a <code>SYNTAX_ERR</code> exception.

   <li>
    <p>If the <span>origin</span> of the resulting <span>absolute URL</span>
     is not the <span title="same origin">same</span> as the origin of the
     script that invoked the method, then throw a <span>security
     exception</span>.

   <li>
    <p>If the <var title="">name</var> argument is the empty string, <a
     href="#create">create a worker</a> from the resulting <span>absolute
     URL</span>, whose name is the empty string, and return the
     <code>MessagePort</code> object returned from the <a
     href="#create">create a worker</a> algorithm. Then, abort these steps.

   <li>
    <p>If there exists a worker whose <code title=dom-windowworker-closing><a
     href="#closing">closing</a></code> attribute is false, whose <code
     title=dom-windowworker-name><a href="#name">name</a></code> attribute is
     exactly equal to the <var title="">name</var> argument, and whose <code
     title=dom-windowworker-URL><a href="#url">URL</a></code> attribute has
     the <span>same origin</span> as the resulting <span>absolute URL</span>,
     then run these substeps:</p>

    <ol>
     <li>
      <p>If that worker's <code title=dom-windowworker-URL><a
       href="#url">URL</a></code> attribute is not exactly equal to the
       resulting <span>absolute URL</span>, then throw a
       <code>URL_MISMATCH_ERR</code> exception and abort these steps. <span
       class=big-issue>code 19</span>

     <li>
      <p><span>Create a new <code>MessagePort</code> object</span> owned by
       the <span>script execution context</span> of the script that invoked
       the method.

     <li>
      <p>Return that port.

     <li>
      <p>Asynchronously, <a href="#attach" title="attach to a
       worker">attach</a> to this preexisting worker, with the newly created
       port.
    </ol>

    <p>Otherwise, <a href="#create">create a worker</a> from the resulting
     <span>absolute URL</span>, whose name is the value of the <var
     title="">name</var> argument, and return the <code>MessagePort</code>
     object returned from the <a href="#create">create a worker</a>
     algorithm.</p>
  </ol>

  <hr>

  <p>The steps to <dfn id=create>create a worker</dfn> from a
   <span>URL</span> <var title="">url</var> and whose name is <var
   title="">name</var>, in the context of a method call, are as follows:

  <ol>
   <li>
    <p><span>Create a new <code>MessagePort</code> object</span> owned by the
     <span>script execution context</span> of the script that invoked the
     method.

   <li>
    <p>Return that port.

   <li>
    <p>In a parallel execution context (i.e. a separate thread or process or
     equivalent construct), <a href="#run-a">run a worker</a> named <var
     title="">name</var> for the script with <span>URL</span> <var
     title="">url</var>, with the <span>script browsing context</span> of the
     script that invoked the method as the <var title="">owner browsing
     context</var> and with the <span>script document context</span> of the
     script that invoked the method as the <var title="">owner
     document</var>.</p>

    <p>If that algorithm invokes the steps for <dfn id=success title="worker
     creation succeeded">success steps</dfn>, then <a href="#attach"
     title="attach to a worker">attach</a> to this new worker, with the newly
     created port.</p>

    <p>Otherwise, if the <dfn id=worker>worker creation failed</dfn>, then at
     the next available opportunity, after any scripts have finished
     executing<!-- XXX queue -->, <span>fire a simple event</span> called
     <code title=event-error>error</code> at the newly created port.</p>
  </ol>

  <hr>

  <p>The steps to <dfn id=attach>attach to a worker</dfn> given a
   <code>MessagePort</code> object <var title="">port</var> are as follows:

  <ol>
   <li>
    <p>If <var title="">port</var> would have been garbage collected, or if
     the <span>active document</span> of the <code
     title=dom-MessagePort-ownerWindow>ownerWindow</code> of <var
     title="">port</var> is no longer the same <code>Document</code> object
     as when <var title="">port</var> was created, then do nothing. Abort
     these steps. If the worker was just created, it'll get killed
     immediately.</p>

   <li>
    <p><span>Create a new <code>MessagePort</code> object</span> owned by the
     <code><a href="#windowworker">WindowWorker</a></code> of the worker.

   <li>
    <p><span>Entangle</span> this newly created port and the port <var
     title="">port</var> that was passed to these steps.

   <li>
    <p>Set the <code title=dom-MessagePort-active>active</code> attribute of
     both ports to true.

   <li>
    <p>At the next available opportunity, after any scripts have finished
     executing<!-- XXX queue -->, <span>fire a simple event</span> called
     <code title=event-load>load</code> at <var title="">port</var>.

   <li>
    <p>Create an event that uses the <code>MessageEvent</code> interface,
     with the name <code title=event-attach>attach</code>, which does not
     bubble, is cancelable, has no default action, has a <code
     title=dom-MessageEvent-data>data</code> attribute whose value is the
     empty string and has a <code
     title=dom-MessageEvent-messagePort>messagePort</code> attribute whose
     value is the newly created port, and add it to the worker's <code><a
     href="#windowworker">WindowWorker</a></code> object's <a
     href="#queue">queue of events</a>, targetted at the <code><a
     href="#windowworker">WindowWorker</a></code> object itself.
  </ol>

  <h2 class=no-num id=references>References</h2>

  <p class=big-issue>This section will be written in a future
   draft.<!--XXX-->

  <h2 class=no-num id=acknowledgements>Acknowledgements</h2>
  <!-- ACKS -->

  <p>Thanks to Maciej Stachowiak and Mike Smith for their useful and
   substantial comments.

  <p>Huge thanks to the whole Gears team, who pioneered this technology and
   whose experience has been a huge influence on this specification.
